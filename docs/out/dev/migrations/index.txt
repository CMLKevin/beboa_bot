3:I[4707,[],""]
5:I[6423,[],""]
6:I[2060,["972","static/chunks/972-68a674eeca97bbbb.js","646","static/chunks/646-1e67c3e800eb58dd.js","185","static/chunks/app/layout-4b75b78215e64ea2.js"],"ThemeProvider"]
7:I[4351,["972","static/chunks/972-68a674eeca97bbbb.js","646","static/chunks/646-1e67c3e800eb58dd.js","185","static/chunks/app/layout-4b75b78215e64ea2.js"],"Header"]
8:I[9399,["972","static/chunks/972-68a674eeca97bbbb.js","646","static/chunks/646-1e67c3e800eb58dd.js","185","static/chunks/app/layout-4b75b78215e64ea2.js"],"Sidebar"]
4:["slug","dev/migrations","c"]
0:["FeUt14WxB_Uw-6zJdn3nr",[[["",{"children":[["slug","dev/migrations","c"],{"children":["__PAGE__?{\"slug\":[\"dev\",\"migrations\"]}",{}]}]},"$undefined","$undefined",true],["",{"children":[["slug","dev/migrations","c"],{"children":["__PAGE__",{},[["$L1","$L2",null],null],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","$4","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/3cf59f0fd0496c15.css","precedence":"next","crossOrigin":"$undefined"}]],["$","html",null,{"lang":"en","suppressHydrationWarning":true,"children":["$","body",null,{"className":"__variable_f367f3 __variable_a06722 font-sans","children":["$","$L6",null,{"children":["$","div",null,{"className":"min-h-screen bg-[var(--bg-primary)] transition-colors duration-200","children":[["$","$L7",null,{}],["$","div",null,{"className":"flex","children":[["$","$L8",null,{}],["$","main",null,{"className":"flex-1 min-w-0 lg:pl-[var(--sidebar-width)]","children":["$","div",null,{"className":"max-w-[var(--content-max-width)] mx-auto px-6 py-8 lg:px-8 lg:py-12","children":["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[]}]}]}]]}]]}]}]}]}]],null],null],["$L9",null]]]]
a:I[6430,["972","static/chunks/972-68a674eeca97bbbb.js","646","static/chunks/646-1e67c3e800eb58dd.js","877","static/chunks/app/%5B...slug%5D/page-ea4807ff1312ce17.js"],"Breadcrumbs"]
b:I[9078,["972","static/chunks/972-68a674eeca97bbbb.js","646","static/chunks/646-1e67c3e800eb58dd.js","877","static/chunks/app/%5B...slug%5D/page-ea4807ff1312ce17.js"],"CopyPageButton"]
d:I[3308,["972","static/chunks/972-68a674eeca97bbbb.js","646","static/chunks/646-1e67c3e800eb58dd.js","877","static/chunks/app/%5B...slug%5D/page-ea4807ff1312ce17.js"],"PageNavigation"]
e:I[5321,["972","static/chunks/972-68a674eeca97bbbb.js","646","static/chunks/646-1e67c3e800eb58dd.js","877","static/chunks/app/%5B...slug%5D/page-ea4807ff1312ce17.js"],"TableOfContents"]
2:[["$","article",null,{"className":"animate-in","children":[["$","div",null,{"className":"flex items-start justify-between gap-4 mb-6","children":[["$","$La",null,{}],["$","$Lb",null,{}]]}],["$","h1",null,{"children":"Migrations"}],"$undefined",["$","div",null,{"className":"prose-custom","children":"$Lc"}],["$","$Ld",null,{}]]}],["$","$Le",null,{}]]
9:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"Migrations - Beboa Docs"}],["$","link","3",{"rel":"icon","href":"/favicon.ico"}],["$","meta","4",{"name":"next-size-adjust"}]]
1:null
f:I[5045,["972","static/chunks/972-68a674eeca97bbbb.js","646","static/chunks/646-1e67c3e800eb58dd.js","877","static/chunks/app/%5B...slug%5D/page-ea4807ff1312ce17.js"],"CodeBlock"]
10:T54d,// In src/services/database.js

function migration010AddGuildSettings(db) {
    // Create new table
    db.exec(`
        CREATE TABLE IF NOT EXISTS guild_settings (
            guild_id TEXT PRIMARY KEY,
            checkin_channel_id TEXT,
            notification_channel_id TEXT,
            admin_role_id TEXT,
            prefix TEXT DEFAULT '!',
            language TEXT DEFAULT 'en',
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            updated_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    `);

    // Add indexes
    db.exec(`
        CREATE INDEX IF NOT EXISTS idx_guild_settings_updated
        ON guild_settings(updated_at)
    `);

    // Migrate existing config if from single-guild setup
    const guildId = process.env.GUILD_ID;
    if (guildId) {
        db.prepare(`
            INSERT OR IGNORE INTO guild_settings
            (guild_id, checkin_channel_id, notification_channel_id, admin_role_id)
            VALUES (?, ?, ?, ?)
        `).run(
            guildId,
            process.env.CHECKIN_CHANNEL_ID,
            process.env.NOTIFICATION_CHANNEL_ID,
            process.env.ADMIN_ROLE_ID
        );
    }

    console.log('[MIGRATION] Guild settings table created');
}

// Register
const migrations = [
    // ... existing migrations
    { name: '010_add_guild_settings', up: migration010AddGuildSettings },
];c:[["$","h1",null,{"id":"database-migrations","children":"Database Migrations"}],"\n",["$","p",null,{"children":"Guide to safely updating the database schema."}],"\n",["$","h2",null,{"id":"migration-system","children":["$","a",null,{"href":"#migration-system","className":"anchor-link","children":"Migration System"}]}],"\n",["$","p",null,{"children":"Beboa uses a simple migration system to track schema changes:"}],"\n",["$","$Lf",null,{"language":"$undefined","children":"data/\n├── beboa.db           # Main database\n└── migrations/        # Migration scripts (optional)"}],"\n",["$","h2",null,{"id":"migration-table","children":["$","a",null,{"href":"#migration-table","className":"anchor-link","children":"Migration Table"}]}],"\n",["$","$Lf",null,{"language":"sql","children":"CREATE TABLE IF NOT EXISTS migrations (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    name TEXT UNIQUE NOT NULL,\n    applied_at TEXT DEFAULT CURRENT_TIMESTAMP\n);"}],"\n",["$","h2",null,{"id":"running-migrations","children":["$","a",null,{"href":"#running-migrations","className":"anchor-link","children":"Running Migrations"}]}],"\n",["$","p",null,{"children":["Migrations run automatically on startup in ",["$","code",null,{"children":"src/services/database.js"}],":"]}],"\n",["$","$Lf",null,{"language":"javascript","children":"function runMigrations() {\n    const migrations = [\n        { name: '001_initial_schema', up: migration001 },\n        { name: '002_add_memories', up: migration002 },\n        { name: '003_add_chat_history', up: migration003 },\n        // Add new migrations here\n    ];\n\n    for (const migration of migrations) {\n        const applied = db.prepare(\n            'SELECT 1 FROM migrations WHERE name = ?'\n        ).get(migration.name);\n\n        if (!applied) {\n            console.log(`[DB] Running migration: ${migration.name}`);\n            migration.up(db);\n            db.prepare('INSERT INTO migrations (name) VALUES (?)').run(migration.name);\n        }\n    }\n}"}],"\n",["$","h2",null,{"id":"writing-migrations","children":["$","a",null,{"href":"#writing-migrations","className":"anchor-link","children":"Writing Migrations"}]}],"\n",["$","h3",null,{"id":"adding-a-column","children":["$","a",null,{"href":"#adding-a-column","className":"anchor-link","children":"Adding a Column"}]}],"\n",["$","$Lf",null,{"language":"javascript","children":"function migration004AddUserTimezone(db) {\n    // Check if column exists\n    const columns = db.pragma('table_info(users)');\n    const hasTimezone = columns.some(c => c.name === 'timezone');\n\n    if (!hasTimezone) {\n        db.exec(`\n            ALTER TABLE users\n            ADD COLUMN timezone TEXT DEFAULT 'UTC'\n        `);\n    }\n}"}],"\n",["$","h3",null,{"id":"adding-a-table","children":["$","a",null,{"href":"#adding-a-table","className":"anchor-link","children":"Adding a Table"}]}],"\n",["$","$Lf",null,{"language":"javascript","children":"function migration005AddAchievements(db) {\n    db.exec(`\n        CREATE TABLE IF NOT EXISTS achievements (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            user_id TEXT NOT NULL,\n            achievement_id TEXT NOT NULL,\n            unlocked_at TEXT DEFAULT CURRENT_TIMESTAMP,\n            FOREIGN KEY (user_id) REFERENCES users(user_id),\n            UNIQUE(user_id, achievement_id)\n        );\n\n        CREATE INDEX IF NOT EXISTS idx_achievements_user\n        ON achievements(user_id);\n    `);\n}"}],"\n",["$","h3",null,{"id":"adding-an-index","children":["$","a",null,{"href":"#adding-an-index","className":"anchor-link","children":"Adding an Index"}]}],"\n",["$","$Lf",null,{"language":"javascript","children":"function migration006AddBebitIndex(db) {\n    db.exec(`\n        CREATE INDEX IF NOT EXISTS idx_users_bebits_desc\n        ON users(bebits DESC)\n    `);\n}"}],"\n",["$","h3",null,{"id":"modifying-data","children":["$","a",null,{"href":"#modifying-data","className":"anchor-link","children":"Modifying Data"}]}],"\n",["$","$Lf",null,{"language":"javascript","children":"function migration007NormalizeUsernames(db) {\n    // Get all users\n    const users = db.prepare('SELECT user_id, username FROM users').all();\n\n    // Update each user\n    const update = db.prepare('UPDATE users SET username = ? WHERE user_id = ?');\n\n    for (const user of users) {\n        if (user.username) {\n            const normalized = user.username.toLowerCase().trim();\n            update.run(normalized, user.user_id);\n        }\n    }\n}"}],"\n",["$","h2",null,{"id":"migration-best-practices","children":["$","a",null,{"href":"#migration-best-practices","className":"anchor-link","children":"Migration Best Practices"}]}],"\n",["$","h3",null,{"id":"always-use-if-not-exists","children":["$","a",null,{"href":"#always-use-if-not-exists","className":"anchor-link","children":"Always Use IF NOT EXISTS"}]}],"\n",["$","$Lf",null,{"language":"javascript","children":"// Good\ndb.exec('CREATE TABLE IF NOT EXISTS new_table (...)');\ndb.exec('CREATE INDEX IF NOT EXISTS idx_name ON table(column)');\n\n// Bad - will fail if run twice\ndb.exec('CREATE TABLE new_table (...)');"}],"\n",["$","h3",null,{"id":"check-before-altering","children":["$","a",null,{"href":"#check-before-altering","className":"anchor-link","children":"Check Before Altering"}]}],"\n",["$","$Lf",null,{"language":"javascript","children":"function safeAddColumn(db, table, column, definition) {\n    const columns = db.pragma(`table_info(${table})`);\n    const exists = columns.some(c => c.name === column);\n\n    if (!exists) {\n        db.exec(`ALTER TABLE ${table} ADD COLUMN ${column} ${definition}`);\n        return true;\n    }\n    return false;\n}\n\n// Usage\nsafeAddColumn(db, 'users', 'new_column', 'TEXT DEFAULT NULL');"}],"\n",["$","h3",null,{"id":"use-transactions-for-data-migrations","children":["$","a",null,{"href":"#use-transactions-for-data-migrations","className":"anchor-link","children":"Use Transactions for Data Migrations"}]}],"\n",["$","$Lf",null,{"language":"javascript","children":"function migration008ComplexDataMigration(db) {\n    const transaction = db.transaction(() => {\n        // Multiple operations\n        db.exec('UPDATE users SET status = \"active\" WHERE status IS NULL');\n        db.exec('DELETE FROM old_table WHERE migrated = 1');\n        db.exec('INSERT INTO new_table SELECT * FROM temp_table');\n    });\n\n    transaction();\n}"}],"\n",["$","h3",null,{"id":"log-migration-progress","children":["$","a",null,{"href":"#log-migration-progress","className":"anchor-link","children":"Log Migration Progress"}]}],"\n",["$","$Lf",null,{"language":"javascript","children":"function migration009LargeMigration(db) {\n    console.log('[MIGRATION] Starting large migration...');\n\n    const total = db.prepare('SELECT COUNT(*) as count FROM large_table').get().count;\n    let processed = 0;\n\n    const rows = db.prepare('SELECT * FROM large_table').all();\n\n    for (const row of rows) {\n        // Process row\n        processed++;\n        if (processed % 1000 === 0) {\n            console.log(`[MIGRATION] Processed ${processed}/${total}`);\n        }\n    }\n\n    console.log('[MIGRATION] Complete!');\n}"}],"\n",["$","h2",null,{"id":"registering-migrations","children":["$","a",null,{"href":"#registering-migrations","className":"anchor-link","children":"Registering Migrations"}]}],"\n",["$","p",null,{"children":["Migrations are registered in ",["$","code",null,{"children":"src/migrations/index.js"}],":"]}],"\n",["$","$Lf",null,{"language":"javascript","children":"import migration001 from './001_initial_schema.js';\nimport migration002 from './002_add_memories.js';\nimport migration003 from './003_add_chat_history.js';\nimport migration004 from './004_add_personality.js';\nimport migration005 from './005_add_relationships.js';\nimport migration006 from './006_add_server_memory.js';\n\nexport const migrations = [\n    migration001,\n    migration002,\n    migration003,\n    migration004,\n    migration005,\n    migration006,  // Server-wide memory tables\n];"}],"\n",["$","h2",null,{"id":"recent-migrations","children":["$","a",null,{"href":"#recent-migrations","className":"anchor-link","children":"Recent Migrations"}]}],"\n",["$","h3",null,{"id":"006_add_server_memory","children":["$","a",null,{"href":"#006_add_server_memory","className":"anchor-link","children":"006_add_server_memory"}]}],"\n",["$","p",null,{"children":"Adds server-wide memory tables for ambient awareness:"}],"\n",["$","$Lf",null,{"language":"javascript","children":"// Tables created:\n// - server_messages: Raw storage for ALL server messages\n// - server_embeddings: Vector embeddings for important messages\n// - channel_summaries: Periodic channel rollups (hourly/daily)\n// - active_topics: Topic lifecycle tracking\n// - embedding_queue: Background processing queue\n// - channel_metadata: Channel statistics"}],"\n",["$","p",null,{"children":["See ",["$","a",null,{"href":"/ai/server-memory","children":"Server-Wide Memory"}]," for full documentation."]}],"\n",["$","h2",null,{"id":"rolling-back","children":["$","a",null,{"href":"#rolling-back","className":"anchor-link","children":"Rolling Back"}]}],"\n",["$","p",null,{"children":"SQLite doesn't support easy rollbacks. For safety:"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":["$","strong",null,{"children":"Always backup before migrations"}]}],"\n"]}],"\n",["$","$Lf",null,{"language":"bash","children":"cp data/beboa.db data/beboa_backup_$(date +%Y%m%d_%H%M%S).db"}],"\n",["$","ol",null,{"start":"2","children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"Write rollback scripts"}]," (optional)"]}],"\n"]}],"\n",["$","$Lf",null,{"language":"javascript","children":"const migrations = [\n    {\n        name: '004_add_timezone',\n        up: (db) => {\n            db.exec('ALTER TABLE users ADD COLUMN timezone TEXT');\n        },\n        down: (db) => {\n            // SQLite doesn't support DROP COLUMN easily\n            // Would need to recreate table\n        }\n    }\n];"}],"\n",["$","ol",null,{"start":"3","children":["\n",["$","li",null,{"children":["$","strong",null,{"children":"Test on copy first"}]}],"\n"]}],"\n",["$","$Lf",null,{"language":"bash","children":"cp data/beboa.db data/test.db\n# Run migration on test.db first"}],"\n",["$","h2",null,{"id":"complete-migration-example","children":["$","a",null,{"href":"#complete-migration-example","className":"anchor-link","children":"Complete Migration Example"}]}],"\n",["$","$Lf",null,{"language":"javascript","children":"$10"}],"\n",["$","h2",null,{"id":"troubleshooting","children":["$","a",null,{"href":"#troubleshooting","className":"anchor-link","children":"Troubleshooting"}]}],"\n",["$","h3",null,{"id":"migration-wont-run","children":["$","a",null,{"href":"#migration-wont-run","className":"anchor-link","children":"Migration Won't Run"}]}],"\n",["$","p",null,{"children":"Check if already applied:"}],"\n",["$","$Lf",null,{"language":"sql","children":"SELECT * FROM migrations WHERE name = 'migration_name';"}],"\n",["$","h3",null,{"id":"need-to-re-run-migration","children":["$","a",null,{"href":"#need-to-re-run-migration","className":"anchor-link","children":"Need to Re-run Migration"}]}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Dangerous - only for development:"}]}],"\n",["$","$Lf",null,{"language":"sql","children":"DELETE FROM migrations WHERE name = 'migration_name';"}],"\n",["$","h3",null,{"id":"database-locked","children":["$","a",null,{"href":"#database-locked","className":"anchor-link","children":"Database Locked"}]}],"\n",["$","p",null,{"children":"Stop all bot instances before running migrations."}],"\n",["$","h3",null,{"id":"check-migration-status","children":["$","a",null,{"href":"#check-migration-status","className":"anchor-link","children":"Check Migration Status"}]}],"\n",["$","$Lf",null,{"language":"javascript","children":"function getMigrationStatus() {\n    return db.prepare('SELECT * FROM migrations ORDER BY applied_at').all();\n}"}]]
